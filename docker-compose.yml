version: '3.8'

services:
  analysis-engine:
    build:
      context: .
      dockerfile: analysis_engine/Dockerfile
    container_name: threat-hunting-analysis-engine
    ports:
      - "${ANALYSIS_API_PORT:-8000}:8000"
    environment:
      - ANALYSIS_API_HOST=${ANALYSIS_API_HOST:-0.0.0.0}
      - ANALYSIS_API_PORT=8000
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      - ./output:/app/output
      - ./generator:/app/generator
      - ./analysis_engine:/app/analysis_engine
    networks:
      - threat-hunting-net
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health').read()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  soc-dashboard:
    build:
      context: ./ui/soc_dashboard
      dockerfile: Dockerfile
    container_name: threat-hunting-soc-dashboard
    ports:
      - "${UI_PORT:-3000}:3000"
    environment:
      - REACT_APP_API_BASE_URL=http://localhost:${ANALYSIS_API_PORT:-8000}
      - NODE_ENV=production
    depends_on:
      - analysis-engine
    networks:
      - threat-hunting-net
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000', (res) => { process.exit(res.statusCode === 200 ? 0 : 1); }).on('error', () => { process.exit(1); })"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  threat-hunting-net:
    driver: bridge
